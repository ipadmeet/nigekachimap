<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ‹ã‚²ã‚«ãƒãƒãƒƒãƒ—</title>

<style>
/* ===== å›ºå®šãƒ˜ãƒƒãƒ€ãƒ¼ (é«˜ã•40px) ===== */
#header {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 40px;
    background: #ffffff;
    border-bottom: 1px solid #ccc;
    z-index: 1001;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 0 10px;
    box-sizing: border-box;
}

#header-title {
    font-size: 20px;
    font-weight: bold;
}

/* ğŸ“ ãƒ˜ãƒƒãƒ€ãƒ¼å†…ã®å³ä¸‹ãƒªãƒ³ã‚¯ */
#header-copy {
    position: absolute;
    right: 10px;
    bottom: 2px; /* ãƒ˜ãƒƒãƒ€ãƒ¼å†…ã®ä¸‹å´ã«é…ç½® */
    font-size: 14px;
    line-height: 1;
}

#header-copy a {
    color: #666;
    text-decoration: none;
    font-family: Arial, sans-serif;
}

#header-copy a:hover {
    text-decoration: underline;
}

/* ğŸ” å³ä¸Šã®æ“ä½œãƒ‘ãƒãƒ«ï¼ˆæ¤œç´¢ï¼‹ãƒšãƒ³ï¼‰ */
#action-controls {
    position: fixed;
    top: 36px;
    right: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    z-index: 1002;
}

#search-container {
    display: flex;
    gap: 5px;
    background: rgba(255, 255, 255, 0.9);
    padding: 5px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

#address-input {
    padding: 4px 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    width: 120px;
    font-size: 12px;
}

#search-btn {
    padding: 4px 10px;
    background: #4285F4;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
}

.pen-icon {
    width: 40px;
    height: 40px;
    background: white;
    border: 1px solid #aaa;
    border-radius: 50%;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

/* Googleãƒãƒƒãƒ—å†…ã®ãƒœã‚¿ãƒ³ä½ç½®å¾®èª¿æ•´ */
#map .gm-style-mtc {
    margin-top: 14px !important;
}

/* ğŸ“¸ å¹ãå‡ºã—å†…ã®ç”»åƒã‚¹ã‚¿ã‚¤ãƒ« */
.preview {
    width: 100px;
    height: auto;
    display: block;
    margin: 8px auto 0;
    border-radius: 4px;
    border: 1px solid #eee;
}

#map {
    height: 100vh;
    width: 100%;
}

.form-window {
    position: fixed;
    top: 90px;
    right: 15px;
    background: white;
    padding: 15px;
    border: 1px solid #ccc;
    border-radius: 8px;
    z-index: 1003;
    width: 280px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
</style>
</head>

<body>

<div id="header">
    <div id="header-title">ãƒ‹ã‚²ã‚«ãƒãƒãƒƒãƒ—</div>
    <div id="header-copy">
        <a href="https://sites.google.com/view/nigekachi/" target="_blank" rel="noopener noreferrer">
            Â©ãƒ‹ã‚²ã‚«ãƒLabo
        </a>
    </div>
</div>

<div id="action-controls">
    <div id="search-container">
        <input type="text" id="address-input" placeholder="åœ°åã‚’å…¥åŠ›">
        <button id="search-btn" onclick="searchAddress()">æ¤œç´¢</button>
    </div>
    <div class="pen-icon" onclick="toggleLoginUI()">âœï¸</div>
</div>

<div id="login-form" class="form-window" style="display:none;">
    <input id="email" type="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" style="width:90%; margin-bottom:10px;"><br>
    <input id="password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="width:90%; margin-bottom:10px;"><br>
    <button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    <button onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    <p id="login-status" style="font-size:12px; color:#666;"></p>
</div>

<div id="report-form" class="form-window" style="display:none; left: 15px; right: auto;">
    <label><b>1. åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å ´æ‰€æŒ‡å®š</b></label><br><br>
    <label>æ—¥æ™‚</label><br>
    <input type="datetime-local" id="report-datetime" style="width:90%; margin-bottom:10px;"><br>
    <label>çŠ¶æ³ã®è©³ç´°</label><br>
    <textarea id="description" rows="3" style="width:90%;"></textarea><br><br>
    <label>ç”»åƒï¼ˆä»»æ„ï¼‰</label><br>
    <input type="file" id="image-input" accept="image/*" style="width:90%; margin-bottom:10px;"><br><br>
    <button id="submit-btn" onclick="submitReport()" style="padding: 5px 10px;">æŠ•ç¨¿ã™ã‚‹</button>
</div>

<div id="map"></div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyB_ft6Nsv511VwGh73Peljdkhvc4cT1PK8",
    authDomain: "danger-e17d4.firebaseapp.com",
    projectId: "danger-e17d4",
    storageBucket: "danger-e17d4.firebasestorage.app",
    messagingSenderId: "671800740218",
    appId: "1:671800740218:web:a95e9750fbf79905ea2ec3"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

let map, geocoder, tempMarker, selectedLocation = null;

function initMap() {
    geocoder = new google.maps.Geocoder();
    map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 36.3680, lng: 140.4600 },
        zoom: 16,
        mapTypeControl: true,
        mapTypeControlOptions: {
            style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
            position: google.maps.ControlPosition.LEFT_TOP
        },
        fullscreenControl: true,
        fullscreenControlOptions: {
            position: google.maps.ControlPosition.RIGHT_BOTTOM
        },
        streetViewControl: true,
        streetViewControlOptions: {
            position: google.maps.ControlPosition.RIGHT_BOTTOM
        }
    });

    map.addListener("click", e => {
        if (!auth.currentUser) { alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™"); return; }
        selectedLocation = { lat: e.latLng.lat(), lng: e.latLng.lng() };
        if (tempMarker) tempMarker.setMap(null);
        tempMarker = new google.maps.Marker({ position: selectedLocation, map: map });
    });

    listenForReports();
}

function searchAddress() {
    const address = document.getElementById('address-input').value;
    if (!address) return;
    geocoder.geocode({ 'address': address }, (results, status) => {
        if (status === 'OK') {
            map.setCenter(results[0].geometry.location);
        }
    });
}

function toggleLoginUI() {
    const form = document.getElementById("login-form");
    form.style.display = (form.style.display === "none") ? "block" : "none";
}

auth.onAuthStateChanged(user => {
    document.getElementById("report-form").style.display = user ? "block" : "none";
    document.getElementById("login-status").textContent = user ? "ãƒ­ã‚°ã‚¤ãƒ³ä¸­" : "æŠ•ç¨¿ã¯ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿ã§ã™ã€‚";
});

function login() {
    auth.signInWithEmailAndPassword(document.getElementById("email").value, document.getElementById("password").value)
    .catch(() => alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—"));
}

function logout() { auth.signOut(); }

function listenForReports() {
    db.collection("reports").onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
            if (change.type === "added") {
                const d = change.doc.data();
                const marker = new google.maps.Marker({
                    position: { lat: d.latitude, lng: d.longitude },
                    map: map
                });

                const imageHtml = d.imageUrl ? `<img src="${d.imageUrl}" class="preview">` : "";
                const time = d.reportTimestamp ? d.reportTimestamp.toDate().toLocaleString() : "ä¸æ˜";

                const info = new google.maps.InfoWindow({
                    content: `
                        <div style="max-width:200px; font-size:13px;">
                            <b style="display:block; margin-bottom:4px;">å±é™ºç®‡æ‰€</b>
                            <small style="color:#666;">${time}</small>
                            <p style="margin:5px 0;">${d.description}</p>
                            ${imageHtml}
                        </div>
                    `
                });
                marker.addListener("click", () => info.open(map, marker));
            }
        });
    });
}

async function submitReport() {
    const btn = document.getElementById("submit-btn");
    const descInput = document.getElementById("description");
    const fileInput = document.getElementById("image-input");

    if (!selectedLocation || !descInput.value.trim()) { alert("å ´æ‰€ã¨è©³ç´°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

    btn.disabled = true;
    try {
        let imageUrl = "";
        const file = fileInput.files[0];
        if (file) {
            const ref = storage.ref(`reports/${Date.now()}_${file.name}`);
            const snap = await ref.put(file);
            imageUrl = await snap.ref.getDownloadURL();
        }

        await db.collection("reports").add({
            latitude: selectedLocation.lat,
            longitude: selectedLocation.lng,
            description: descInput.value,
            imageUrl: imageUrl,
            username: "ãƒ‹ã‚²ã‚«ãƒ",
            reportTimestamp: firebase.firestore.Timestamp.fromDate(new Date())
        });

        alert("æŠ•ç¨¿ã—ã¾ã—ãŸ");
        descInput.value = "";
        fileInput.value = "";
        if (tempMarker) tempMarker.setMap(null);
        selectedLocation = null;
    } catch (e) { alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"); }
    btn.disabled = false;
}
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC3WivvfQ9Y-qkXpjXwWXGGEXGKDOPhvMw&callback=initMap"></script>

</body>
</html>
