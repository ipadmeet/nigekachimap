<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ‹ã‚²ã‚«ãƒãƒãƒƒãƒ—</title>

<style>
/* ===== å›ºå®šãƒ˜ãƒƒãƒ€ãƒ¼ ===== */
#header {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 36px;
    background: #ffffff;
    border-bottom: 1px solid #ccc;
    z-index: 1001;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

/* ã‚¿ã‚¤ãƒˆãƒ« */
#header-title {
    font-size: 20px;
    font-weight: bold;
    line-height: 1.2;
}

/* ã‚³ãƒ”ãƒ¼ãƒ©ã‚¤ãƒˆï¼ˆä¸‹éƒ¨ï¼‰ */
#header-copy {
    position: absolute;
    bottom: 4px;
    right: 10px;
    font-size: 11px;
}


/* ===== åœ°å›³ ===== */
#map {
    height: 1080px;
    width: 100%;
    margin-top: 56px; /* â† ãƒ˜ãƒƒãƒ€ãƒ¼åˆ†ãšã‚‰ã™ */
}

#login-form, #report-form {
    padding: 15px;
    border: 1px solid #ccc;
    border-radius: 5px;
    margin: 10px;
    background: #fff;
}

/* ğŸ–Š ãƒšãƒ³ãƒœã‚¿ãƒ³ */
.pen-icon {
    position: fixed;
    top: 62px; /* â† ãƒ˜ãƒƒãƒ€ãƒ¼ã®ä¸‹ã«é…ç½® */
    right: 15px;
    width: 44px;
    height: 44px;
    background: white;
    border: 1px solid #aaa;
    border-radius: 50%;
    font-size: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1002;
}
</style>
</head>

<body>

<!-- ===== å›ºå®šã‚¿ã‚¤ãƒˆãƒ« ===== -->
<div id="header">
    <div id="header-title">ãƒ‹ã‚²ã‚«ãƒãƒãƒƒãƒ—</div>
    <div id="header-copy">
        <a href="https://sites.google.com/view/nigekachi/"
           target="_blank"
           rel="noopener noreferrer"
           style="color:#555; text-decoration:none;">
            Â©ãƒ‹ã‚²ã‚«ãƒLabo
        </a>
    </div>
</div>

<!-- ğŸ–Š ãƒšãƒ³ãƒœã‚¿ãƒ³ -->
<div class="pen-icon" onclick="toggleLoginUI()">âœï¸</div>

<!-- ğŸ” ãƒ­ã‚°ã‚¤ãƒ³UI -->
<div id="login-form" style="display:none;">
    <input id="email" type="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" style="width:90%; margin-bottom:10px;"><br>
    <input id="password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="width:90%; margin-bottom:10px;"><br>
    <button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    <button onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    <p id="login-status"></p>
</div>

<!-- ğŸ“ æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ  -->
<div id="report-form" style="display:none;">
    <label>æ—¥æ™‚</label><br>
    <input type="datetime-local" id="report-datetime" style="width:90%; margin-bottom:10px;"><br>

    <label>çŠ¶æ³ã®è©³ç´°</label><br>
    <textarea id="description" rows="3" style="width:90%;"></textarea><br><br>

    <button onclick="submitReport()">æŠ•ç¨¿ã™ã‚‹</button>
</div>

<div id="map"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyB_ft6Nsv511VwGh73Peljdkhvc4cT1PK8",
    authDomain: "danger-e17d4.firebaseapp.com",
    projectId: "danger-e17d4",
    storageBucket: "danger-e17d4.firebasestorage.app",
    messagingSenderId: "671800740218",
    appId: "1:671800740218:web:a95e9750fbf79905ea2ec3"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

let map;
let selectedLocation = null;
let tempMarker = null;

function toggleLoginUI() {
    const form = document.getElementById("login-form");
    form.style.display = (form.style.display === "none") ? "block" : "none";
}

auth.onAuthStateChanged(user => {
    if (user) {
        document.getElementById("report-form").style.display = "block";
        document.getElementById("login-status").textContent = "ãƒ­ã‚°ã‚¤ãƒ³ä¸­";
    } else {
        document.getElementById("report-form").style.display = "none";
        document.getElementById("login-status").textContent =
            "æŠ•ç¨¿ã§ãã‚‹ã®ã¯ãƒ‹ã‚²ã‚«ãƒã®ãƒ¡ãƒ³ãƒãƒ¼ã ã‘ã§ã™ã€‚å±é™ºæƒ…å ±ã‚’å…±æœ‰ã„ãŸã ã‘ã‚‹æ–¹ã¯ãŠå•åˆã›ã‚ˆã‚ŠãŠä¼ãˆãã ã•ã„ã€‚";
    }
});

function login() {
    auth.signInWithEmailAndPassword(email.value, password.value)
        .catch(() => alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—"));
}

function logout() {
    auth.signOut();
}

function initMap() {
    const center = { lat: 36.3658, lng: 140.4764 };

    map = new google.maps.Map(document.getElementById("map"), {
        center,
        zoom: 16
    });

    map.addListener("click", e => {
        if (!auth.currentUser) {
            alert("æŠ•ç¨¿ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
            return;
        }

        selectedLocation = {
            lat: e.latLng.lat(),
            lng: e.latLng.lng()
        };

        if (tempMarker) tempMarker.setMap(null);

        tempMarker = new google.maps.Marker({
            position: selectedLocation,
            map,
            icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
        });
    });

    listenForReports();
}

function listenForReports() {
    db.collection("reports").onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
            if (change.type === "added") {
                const d = change.doc.data();

                const marker = new google.maps.Marker({
                    position: { lat: d.latitude, lng: d.longitude },
                    map,
                    icon: "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
                });

                const time = d.reportTimestamp
                    ? new Date(d.reportTimestamp.toDate()).toLocaleString()
                    : "ä¸æ˜";

                const info = new google.maps.InfoWindow({
                    content: `
                        <h3>å±é™ºç®‡æ‰€</h3>
                        <strong>æ—¥æ™‚:</strong> ${time}<br>
                        <strong>è©³ç´°:</strong> ${d.description}<br>
                        <strong>æŠ•ç¨¿è€…:</strong> ${d.username}
                    `
                });

                marker.addListener("click", () => info.open(map, marker));
            }
        });
    });
}

function submitReport() {
    if (!auth.currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
    if (!selectedLocation) return alert("åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„");
    if (!description.value.trim()) return alert("çŠ¶æ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

    const dateValue = document.getElementById("report-datetime").value;
    const date = dateValue ? new Date(dateValue) : new Date();

    db.collection("reports").add({
        latitude: selectedLocation.lat,
        longitude: selectedLocation.lng,
        description: description.value,
        username: "ãƒ‹ã‚²ã‚«ãƒ",
        reportTimestamp: firebase.firestore.Timestamp.fromDate(date),
        created: firebase.firestore.FieldValue.serverTimestamp()
    });

    alert("æŠ•ç¨¿ã—ã¾ã—ãŸ");
    description.value = "";
    if (tempMarker) tempMarker.setMap(null);
    selectedLocation = null;
}
</script>

<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC3WivvfQ9Y-qkXpjXwWXGGEXGKDOPhvMw&callback=initMap">
</script>

</body>
</html>
